name: Build And Run Test on Mac

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  BUILD_TYPE: Release

jobs:
  Build_and_Run_GTest:
    name: Build and Run GoogleTest
    runs-on: macos-14
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: anaconda-client-env
          miniconda-version: "latest"
          python-version: "3.10"
          channels: conda-forge
          auto-activate-base: false

      - name: Ensure Rosetta 2 (mac)
        if: runner.os == 'macOS'
        run: |
            sudo softwareupdate --install-rosetta --agree-to-license || true

      # Recreate the env as x86_64 so dcmtk/fmjpeg2koj resolve from conda-forge
      - name: Recreate Conda env as osx-64 (Rosetta)
        if: runner.os == 'macOS'
        shell: bash -el {0}
        run: |
          conda deactivate || true
          conda env remove -n anaconda-client-env || true
          CONDA_SUBDIR=osx-64 conda create -y -n anaconda-client-env python=3.10 -c conda-forge
          conda activate anaconda-client-env
          conda config --env --set subdir osx-64

      - name: Install Conda Dependencies
        run: |
          conda install -y mamba
          mamba install -y compilers --file "${{ github.workspace }}/ci-utils/envs/conda_cpp.txt"

      - name: Configure CMake
        run: >
          cmake -B "${{ github.workspace }}"
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          -DBUILD_CLI=ON
          -DRUN_GTEST=ON
          -DALLEXTRAS=ON
          -DCMAKE_PREFIX_PATH="$CONDA_PREFIX"
          -DCMAKE_INSTALL_PREFIX="$CONDA_PREFIX"

      - name: Build
        run: cmake --build "${{ github.workspace }}" --config "${{ env.BUILD_TYPE }}" --parallel 2

      - name: Run GTest Suite
        working-directory: ${{ github.workspace }}
        run: ./tests/runAllTests -C "${{ env.BUILD_TYPE }}"

  Build_and_Run_PyTest:
    name: Build and Run PyTest
    runs-on: macos-14
    defaults:
      run:
        shell: bash -el {0}

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: conda-incubator/setup-miniconda@v3
        with:
          activate-environment: anaconda-client-env
          miniconda-version: "latest"
          python-version: "3.10"
          channels: conda-forge
          auto-activate-base: false

      - name: Ensure Rosetta 2 (mac)
        if: runner.os == 'macOS'
        run: |
            sudo softwareupdate --install-rosetta --agree-to-license || true

      # Recreate the env as x86_64 so dcmtk/fmjpeg2koj resolve from conda-forge
      - name: Recreate Conda env as osx-64 (Rosetta)
        if: runner.os == 'macOS'
        shell: bash -el {0}
        run: |
          conda deactivate || true
          conda env remove -n anaconda-client-env || true
          CONDA_SUBDIR=osx-64 conda create -y -n anaconda-client-env python=3.10 -c conda-forge
          conda activate anaconda-client-env
          conda config --env --set subdir osx-64


      - name: Install Conda Dependencies
        run: |
          conda install -y mamba
          mamba install -y compilers pytest bfio \
            --file "${{ github.workspace }}/ci-utils/envs/conda_cpp.txt" \
            --file "${{ github.workspace }}/ci-utils/envs/conda_py.txt"

      - name: Install Nyxus
        working-directory: ${{ github.workspace }}
        run: >
          CMAKE_ARGS="-DCMAKE_PREFIX_PATH=$CONDA_PREFIX
          -DCMAKE_INSTALL_PREFIX=$CONDA_PREFIX
          -DALLEXTRAS=ON"
          python -m pip install . -vv

      - name: Run PyTest
        working-directory: ${{ github.workspace }}
        run: python -m pytest tests/python/ -vv
