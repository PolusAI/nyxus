name: Build CUDA 11 Wheels

on:
  workflow_dispatch:
  pull_request:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-20.04]
        cibw_archs: ["auto64"]
        cibw_build: ["cp38-*", "cp39-*", "cp310-*", "cp311-*"]

    steps:
      - uses: actions/checkout@v3
        name: Check out
        with:
          submodules: recursive    

      - name: Delete Latest MSVC Components
        if: runner.os == 'Windows'
        run: |
                Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
                $InstallPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
                $componentsToRemove= @(
                    "Microsoft.VisualStudio.Component.VC.ARM"                       
                    "Microsoft.VisualStudio.Component.VC.ARM64"                     
                    "Microsoft.VisualStudio.Component.VC.ASAN"                                  
                    "Microsoft.VisualStudio.Component.VC.ATL"                                   
                    "Microsoft.VisualStudio.Component.VC.ATL.ARM"                               
                    "Microsoft.VisualStudio.Component.VC.ATL.ARM.Spectre"                       
                    "Microsoft.VisualStudio.Component.VC.ATL.ARM64"                             
                    "Microsoft.VisualStudio.Component.VC.ATL.ARM64.Spectre"                     
                    "Microsoft.VisualStudio.Component.VC.ATL.Spectre"                           
                    "Microsoft.VisualStudio.Component.VC.ATLMFC"                                
                    "Microsoft.VisualStudio.Component.VC.ATLMFC.Spectre"                        
                    "Microsoft.VisualStudio.Component.VC.CLI.Support"                           
                    "Microsoft.VisualStudio.Component.VC.CMake.Project"                         
                    "Microsoft.VisualStudio.Component.VC.CoreIde"                               
                    "Microsoft.VisualStudio.Component.VC.DiagnosticTools"                       
                    "Microsoft.VisualStudio.Component.VC.Llvm.Clang"                            
                    "Microsoft.VisualStudio.Component.VC.Llvm.ClangToolset"                     
                    "Microsoft.VisualStudio.Component.VC.MFC.ARM"                               
                    "Microsoft.VisualStudio.Component.VC.MFC.ARM.Spectre"                       
                    "Microsoft.VisualStudio.Component.VC.MFC.ARM64"                             
                    "Microsoft.VisualStudio.Component.VC.MFC.ARM64.Spectre"                     
                    "Microsoft.VisualStudio.Component.VC.Modules.x86.x64"                       
                    "Microsoft.VisualStudio.Component.VC.Redist.14.Latest"                      
                    "Microsoft.VisualStudio.Component.VC.Redist.MSM"                            
                    "Microsoft.VisualStudio.Component.VC.Runtimes.ARM.Spectre"                  
                    "Microsoft.VisualStudio.Component.VC.Runtimes.ARM64.Spectre"                
                    "Microsoft.VisualStudio.Component.VC.Runtimes.ARM64EC.Spectre"              
                    "Microsoft.VisualStudio.Component.VC.Runtimes.x86.x64.Spectre"              
                    "Microsoft.VisualStudio.Component.VC.TestAdapterForBoostTest"               
                    "Microsoft.VisualStudio.Component.VC.TestAdapterForGoogleTest"              
                    "Microsoft.VisualStudio.Component.VC.Tools.ARM"                             
                    "Microsoft.VisualStudio.Component.VC.Tools.ARM64"                           
                    "Microsoft.VisualStudio.Component.VC.Tools.ARM64EC"                         
                    "Microsoft.VisualStudio.Component.VC.Tools.x86.x64" 
                    
                )
                [string]$workloadArgs = $componentsToRemove | ForEach-Object {" --remove " +  $_}
                $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
                # should be run twice
                $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
                $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
      
      - name: Install MSVC 14.39 Components
        if: runner.os == 'Windows'
        run: |
                Set-Location "C:\Program Files (x86)\Microsoft Visual Studio\Installer\"
                $InstallPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
                $componentsToAdd= @(
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ARM"                       
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ARM64"                     
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ASAN"                                  
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL"                                   
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM"                               
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM.Spectre"                       
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM64"                             
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.ARM64.Spectre"                     
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATL.Spectre"                           
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATLMFC"                                
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.ATLMFC.Spectre"                        
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.CLI.Support"                           
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.CMake.Project"                         
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.CoreIde"                               
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.DiagnosticTools"                       
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Llvm.Clang"                            
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Llvm.ClangToolset"                     
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM"                               
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM.Spectre"                       
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM64"                             
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.MFC.ARM64.Spectre"                     
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Modules.x86.x64"                       
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Redist.14.Latest"                      
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Redist.MSM"                            
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Runtimes.ARM.Spectre"                  
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Runtimes.ARM64.Spectre"                
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Runtimes.ARM64EC.Spectre"              
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Runtimes.x86.x64.Spectre"              
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.TestAdapterForBoostTest"               
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.TestAdapterForGoogleTest"              
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Tools.ARM"                             
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Tools.ARM64"                           
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Tools.ARM64EC"                         
                  "Microsoft.VisualStudio.Component.VC.14.39.17.9.Tools.x86.x64" 
                )
                [string]$workloadArgs = $componentsToAdd | ForEach-Object {" --add " +  $_}
                $Arguments = ('/c', "vs_installer.exe", 'modify', '--installPath', "`"$InstallPath`"",$workloadArgs, '--quiet', '--norestart', '--nocache')
                # should be run twice
                $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden
                $process = Start-Process -FilePath cmd.exe -ArgumentList $Arguments -Wait -PassThru -WindowStyle Hidden


      - name: Add MSVS Path 
        uses: TheMrMilchmann/setup-msvc-dev@v3
        with:
          toolset: 14.39

      - name: Install CUDA
        if: runner.os == 'Windows'
        env: 
          cuda: "11.8.0"
          visual_studio: "Visual Studio 17 2022"
        shell: powershell
        run: .\ci-utils\install_cuda_windows.ps1

      - name: nvcc check
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          nvcc -V
          ls $env:CUDA_PATH
          ls $env:CUDA_PATH\bin
          ls $env:CUDA_PATH\include

      - uses: actions/setup-python@v4
        name: Install Python
        with:
          python-version: '3.9'
 
      - name: Install cibuildwheel
        run: |
          python -m pip install cibuildwheel==2.16.2 delvewheel wheel

      - name: Building wheels 
        run: |
          python -m cibuildwheel --output-dir dist
        env:
          CIBW_BUILD: ${{ matrix.cibw_build }}
          CIBW_SKIP: "*musllinux*"
          CIBW_BUILD_VERBOSITY: 3
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux2014
          CIBW_BEFORE_ALL_LINUX:  yum install -y llvm libevent-devel openssl-devel &&
                                   bash ci-utils/install_cuda_yum.sh 11 && 
                                   bash ci-utils/install_arrow_yum.sh &&
                                   bash ci-utils/install_prereq_linux.sh --build_arrow no &&
                                   mkdir -p /tmp/nyxus_bld &&
                                   cp -r local_install /tmp/nyxus_bld
          CIBW_BEFORE_ALL_WINDOWS: nvcc -V &&
                                   ci-utils\install_prereq_win.bat &&
                                   xcopy /E /I /y local_install C:\TEMP\nyxus_bld\local_install
          CIBW_ENVIRONMENT_LINUX: LD_LIBRARY_PATH="/tmp/nyxus_bld/local_install/lib:/tmp/nyxus_bld/local_install/lib64:/usr/local/cuda/targets/x86_64-linux/lib:$LD_LIBRARY_PATH" CPATH="/usr/local/cuda/targets/x86_64-linux/include:$CPATH" PATH="/usr/local/cuda/bin:$PATH" ON_GITHUB="TRUE" NYXUS_DEP_DIR="/tmp/nyxus_bld/local_install" CXXFLAGS="-I /usr/local/cuda/include" CMAKE_ARGS="-DUSEGPU=ON -DCMAKE_CUDA_COMPILER=/usr/local/cuda/bin/nvcc -DCMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES=/usr/local/cuda/include" 
          CIBW_ENVIRONMENT_WINDOWS: PATH="$TEMP\\nyxus\\bin;$PATH" ON_GITHUB="TRUE" NYXUS_DEP_DIR="C:\\TEMP\\nyxus_bld\\local_install" CMAKE_ARGS="-DUSEGPU=ON"
          CIBW_REPAIR_WHEEL_COMMAND_LINUX: "auditwheel repair --exclude=libcufft.so --exclude=libcufft.so.10 --exclude=libcufft.so.10.4.2.109 --exclude=libcudart.so --exclude=libcudart.so.11.0 --exclude=libcudart.so.11.3.109  -w {dest_dir} {wheel}"
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: "delvewheel repair -vv -w {dest_dir} {wheel} --no-dll=cufft64_10.dll;cufftw64_10.dll;cudart32_110.dll;cudart64_110.dll"
          CIBW_ARCHS: ${{ matrix.cibw_archs }}
          CIBW_TEST_REQUIRES: numpy pandas pyarrow pytest bfio
          CIBW_BEFORE_TEST_WINDOWS: xcopy /E /I /y "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v11.8\bin" %SystemRoot%\System32
          CIBW_TEST_COMMAND: pytest -vv {project}/tests/python -m "not skip_ci"

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: nyxus-cuda11-wheels
          path: dist/*.whl
          retention-days: 1